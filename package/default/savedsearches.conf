[Populate strava_segments KV Store lookup]
search = `strava_index` sourcetype="strava:activities" | spath path=segment_efforts{}.segment.start_latlng{0} output=segment_start_latitude  | spath path=segment_efforts{}.segment.end_latlng{0} output=segment_end_latitude  | spath path=segment_efforts{}.segment.start_latlng{1} output=segment_start_longitude  | spath path=segment_efforts{}.segment.end_latlng{1} output=segment_end_longitude  | rename segment_efforts{}.segment.* as segment_*  | eval segment=mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(mvzip(segment_id,segment_name,"^%$"),segment_distance,"^%$"),segment_activity_type,"^%$"),segment_average_grade,"^%$"),segment_city,"^%$"),segment_climb_category,"^%$"),segment_country,"^%$"),segment_elevation_high,"^%$"),segment_elevation_low,"^%$"),segment_elevation_profile,"^%$"),segment_end_latitude,"^%$"),segment_end_longitude,"^%$"),segment_hazardous,"^%$"),segment_maximum_grade,"^%$"),segment_private,"^%$"),segment_resource_state,"^%$"),segment_starred,"^%$"),segment_start_latitude,"^%$"),segment_start_longitude,"^%$"),segment_state,"^%$") | stats count by segment  | eval id=mvindex(split(segment,"^%$"),0)  | eval name=mvindex(split(segment,"^%$"),1)  | eval distance=mvindex(split(segment,"^%$"),2)  | eval activity_type=mvindex(split(segment,"^%$"),3)  | eval average_grade=mvindex(split(segment,"^%$"),4)  | eval city=mvindex(split(segment,"^%$"),5)  | eval climb_category=mvindex(split(segment,"^%$"),6)  | eval country=mvindex(split(segment,"^%$"),7)  | eval elevation_high=mvindex(split(segment,"^%$"),8)  | eval elevation_low=mvindex(split(segment,"^%$"),9)  | eval elevation_profile=mvindex(split(segment,"^%$"),10)  | eval end_latitude=mvindex(split(segment,"^%$"),11)  | eval end_longitude=mvindex(split(segment,"^%$"),12)  | eval hazardous=mvindex(split(segment,"^%$"),13)  | eval maximum_grade=mvindex(split(segment,"^%$"),14)  | eval private=mvindex(split(segment,"^%$"),15)  | eval resource_state=mvindex(split(segment,"^%$"),16)  | eval starred=mvindex(split(segment,"^%$"),17)  | eval start_latitude=mvindex(split(segment,"^%$"),18)  | eval start_longitude=mvindex(split(segment,"^%$"),19)  | eval state=mvindex(split(segment,"^%$"),20)  | dedup id  | sort 0 - count  | fields - segment  | eval dL = end_longitude-start_longitude  | eval X = cos(end_latitude)*sin(dL)  | eval Y = cos(start_latitude)*sin(end_latitude)-sin(start_latitude)*cos(end_latitude)*cos(dL)  | eval bearing = atan2(X,Y)  | eval degrees = round(180/pi()*bearing)  | eval degrees = if(degrees<0,360+degrees,degrees)  | eval direction = if(degrees<11.25 OR degrees>=348.75,"N",if(degrees>=11.25 AND degrees<33.75,"NNE", if(degrees>=33.75 AND degrees<56.25,"NE",if(degrees>=56.25 AND degrees<78.75,"ENE",if(degrees>=78.75 AND degrees<101.25,"E",if(degrees>=101.25 AND degrees<123.75,"ESE",if(degrees>=123.75 AND degrees<146.25,"SE",if(degrees>=146.25 AND degrees<168.75,"SSE",if(degrees>=168.75 AND degrees<191.25,"S",if(degrees>=191.25 AND degrees<213.75,"SSW",if(degrees>=213.75 AND degrees<236.25,"SW",if(degrees>=236.25 AND degrees<258.75,"WSW",if(degrees>=258.75 AND degrees<281.25,"W",if(degrees>=281.25 AND degrees<303.75,"WNW",if(degrees>=303.75 AND degrees<326.25,"NW",if(degrees>=326.25 AND degrees<348.75,"NW","Unknown"))))))))))))))))  | fields - X,Y,bearing,dL | outputlookup strava_segments
enableSched = 1
cron_schedule = 0 3 * * *
dispatch.earliest_time = 0
dispatch.latest_time = now