name: Build Splunk app for Strava
on: 
  push:
    branches:
      - develop
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.7
      uses: actions/setup-python@v2
      with:
        python-version: 3.7
    - name: Cache pip
      uses: actions/cache@v2
      with:
        # This path is specific to Ubuntu
        path: ~/.cache/pip
        # Look to see if there is a cache hit for the corresponding requirements file
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          ${{ runner.os }}-
    - name: Install dependencies
      # Only check input_module_* files, other files in /bin are generated by Add-On Builder.
      run: | 
        pip install --upgrade pip
        pip install -r ./requirements.txt 
    - name: Lint with pylint
      run: pylint ./bin/input_module_*.py --disable=broad-except,logging-fstring-interpolation,missing-module-docstring,line-too-long,too-many-locals,too-many-nested-blocks
    - name: Bandit Security Test
      run: bandit -r ./bin/*.py
    - name: Build script
      run: ./build.sh
    #- name: Upload artifact
    #  uses: actions/upload-artifact@v2
    #  with:
    #    name: TA-strava-for-splunk.tgz
    #    path: ./
    #    retention-days: 5
    - name: Splunk AppInspect Test
      run: |
        ls -lah
        wget --output-document splunk-appinspect.tar.gz https://download.splunk.com/misc/appinspect/splunk-appinspect-latest.tar.gz
        pip install splunk-appinspect.tar.gz 
        splunk-appinspect inspect ./TA-strava-for-splunk.tgz --mode precert --included-tags cloud
      #- splunk-appinspect inspect ../$APP_NAME*.tgz --mode precert --included-tags cloud | grep "\[  F  ]\|\[  E  ]\|\[  M  ]\[  W  ]"
    # SAMPLE FILE
    # - name: Install dependencies
    #   run: |
    #     python -m pip install --upgrade pip
    #     pip install flake8 pytest
    #     if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    # - name: Lint with flake8
    #   run: |
    #     # stop the build if there are Python syntax errors or undefined names
    #     flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    #     # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
    #     flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    # - name: Test with pytest
    #   run: |
    #     pytest